<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galería - Drive + Excel</title>

  <!-- CSS interno (evita problemas de carga externa) -->
  <style>
    :root{
      --bg:#f5f6f8;
      --card-bg:#fff;
      --accent:#2b7cff;
      --muted:#666;
      --shadow: 0 6px 18px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    body{
      font-family: Inter, system-ui, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      color:#111;
    }
    header{max-width:1100px;margin:0 auto 18px}
    h1{margin:0 0 6px;font-size:26px}
    .subtitle{color:var(--muted);margin:4px 0 10px}
    .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    input[type="text"]{
      padding:10px 12px;border-radius:8px;border:1px solid #d0d7de;flex:1;min-width:260px;
    }
    button{
      padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;
      cursor:pointer;font-weight:600;
    }
    button.secondary{background:#6b7280}
    button:disabled{opacity:.6;cursor:default}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:18px;max-width:1100px;margin:18px auto;
    }
    .card{
      background:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;
      display:flex;flex-direction:column;min-height:320px;
    }
    .imgwrap{background:#eee;display:flex;align-items:center;justify-content:center;height:220px}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:12px}
    .meta h2{margin:0 0 6px;font-size:16px}
    .meta .tecnica{font-size:13px;color:#333;margin-bottom:6px}
    .meta .descripcion{font-size:14px;color:#444;margin:6px 0}
    .meta .precio{font-weight:700;margin-top:6px}
    .loading,.empty,.error{padding:20px;background:var(--card-bg);border-radius:8px;text-align:center;max-width:800px;margin:18px auto}
    .noimg{color:var(--muted);padding:10px}
    footer{max-width:1100px;margin:26px auto;color:var(--muted);font-size:13px}
    .debug{max-width:1100px;margin:14px auto;background:#fff;padding:12px;border-radius:8px;box-shadow:var(--shadow);font-family:monospace;font-size:13px;overflow:auto;max-height:220px}
    @media (max-width:520px){
      .imgwrap{height:180px}
    }
  </style>
</head>
<body>
  <header>
    <h1>Galería de Obras</h1>
    <div class="subtitle">Imágenes desde Google Drive + datos desde Excel (local en el servidor)</div>

    <div class="controls" role="search">
      <input id="folderInput" type="text" placeholder="Pega aquí la URL pública de la carpeta de Drive (ej: https://drive.google.com/drive/folders/XXXXX)">
      <button id="loadBtn">Cargar galería</button>
      <button id="debugBtn" class="secondary">Mostrar respuesta (debug)</button>
      <button id="sampleBtn" class="secondary">Probar carpeta de ejemplo</button>
    </div>
  </header>

  <main id="galeriaContainer">
    <div id="status" class="loading">Pegá la carpeta y hacé click en "Cargar galería".</div>
    <div id="galeria" class="grid" aria-live="polite"></div>
  </main>

  <div id="debug" class="debug" style="display:none;">DEBUG: aquí aparecerá la respuesta JSON</div>

  <footer>
    Consejo: abrí la consola del navegador (F12) y mirá la pestaña Network → petición a <code>/galeria?folder=...</code> para ver errores detallados.
  </footer>

  <script>
    // Elementos
    const folderInput = document.getElementById('folderInput');
    const loadBtn = document.getElementById('loadBtn');
    const galeria = document.getElementById('galeria');
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    const debugBtn = document.getElementById('debugBtn');
    const sampleBtn = document.getElementById('sampleBtn');

    // Rellenar con la carpeta que ya pegaste en la conversación para conveniencia
    folderInput.value = "https://drive.google.com/drive/folders/1yZXl2SuU_vCCj6t-FlTgM0BANUCjly7a?usp=sharing";

    // Leer folder desde query param ?folder=
    (function prefillFromQuery(){
      const params = new URLSearchParams(location.search);
      const f = params.get('folder');
      if(f) folderInput.value = f;
    })();

    function showStatus(text, type="info"){
      status.className = type==="error" ? "error" : (type==="empty" ? "empty" : "loading");
      status.textContent = text;
    }

    function renderItems(items){
      if(!Array.isArray(items)) {
        galeria.innerHTML = "";
        showStatus("Respuesta inválida del servidor.", "error");
        return;
      }
      if(items.length === 0){
        galeria.innerHTML = "";
        showStatus("No se encontraron items.", "empty");
        return;
      }
      status.innerHTML = '';
      galeria.innerHTML = items.map(item => {
        // proteger valores nulos
        const url = item.url || "";
        const nombre = item.nombre || item.imagen || "Sin nombre";
        const tecnica = item.tecnica || "";
        const descripcion = item.descripcion || "";
        const precio = (item.precio !== undefined && item.precio !== null) ? item.precio : "";

        return `
          <article class="card" aria-label="${escapeHtml(nombre)}">
            <div class="imgwrap">
              ${ url ? `<img loading="lazy" src="${escapeHtml(url)}" alt="${escapeHtml(nombre)}">` : '<div class="noimg">Sin imagen</div>' }
            </div>
            <div class="meta">
              <h2>${escapeHtml(nombre)}</h2>
              <div class="tecnica"><strong>Técnica:</strong> ${escapeHtml(tecnica)}</div>
              <p class="descripcion">${escapeHtml(descripcion)}</p>
              <div class="precio"><strong>Precio:</strong> ${escapeHtml(precio)}</div>
            </div>
          </article>
        `;
      }).join('');
    }

    // Sanitize básico
    function escapeHtml(str){
      if(str === null || str === undefined) return "";
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    async function cargarGaleria(folderUrl){
      galeria.innerHTML = "";
      showStatus("Cargando galería desde Drive… Esto puede tardar unos segundos.", "info");
      debug.style.display = "none";
      debug.textContent = "";

      try {
        const endpoint = '/galeria?folder=' + encodeURIComponent(folderUrl);
        const res = await fetch(endpoint, {cache: "no-store"});
        // mostrar cabeceras y código en debug
        debug.textContent = "HTTP " + res.status + " " + res.statusText + "\\n\\n";
        const text = await res.text();
        try {
          const data = JSON.parse(text);
          debug.textContent += JSON.stringify(data, null, 2);
          renderItems(data);
        } catch(parseErr){
          // no JSON -> mostrar texto y error
          debug.textContent += "\\n=== No JSON ===\\n" + text;
          showStatus("El servidor no devolvió JSON válido. Mirá el debug para más info.", "error");
        }
      } catch (err) {
        showStatus("Error al conectar con el servidor: " + err.message, "error");
        debug.style.display = "block";
        debug.textContent = "Fetch error: " + err.stack;
      } finally {
        debug.style.display = debug.textContent ? "block" : "none";
      }
    }

    loadBtn.addEventListener('click', () => {
      const url = folderInput.value.trim();
      if(!url) return alert('Pegá la URL pública de la carpeta de Drive');
      cargarGaleria(url);
    });

    debugBtn.addEventListener('click', () => {
      debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
    });

    // sample folder: carga rápida de prueba (tu carpeta)
    sampleBtn.addEventListener('click', () => {
      const url = folderInput.value.trim();
      if(!url) return alert('Pegá la URL pública de la carpeta de Drive');
      cargarGaleria(url);
    });

    // Si la página se abrió con ?folder=URL intentamos cargar automáticamente
    (function autoload(){
      const params = new URLSearchParams(location.search);
      const f = params.get('folder');
      if(f) {
        // pequeña demora para que el UI se muestre
        setTimeout(()=> cargarGaleria(f), 200);
      }
    })();
  </script>
</body>
</html>
